<nz-card nzTitle="Gestion des Bulletins" nzBordered="false">
  <nz-spin [nzSpinning]="loading">
    <nz-tabset [(nzSelectedIndex)]="activeTab">
      <!-- Onglet 1: Informations des élèves -->
      <nz-tab nzTitle="Informations des élèves">
        <div style="margin-bottom: 16px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
          <nz-select
            [(ngModel)]="selectedClassroomForStudentInfo"
            nzPlaceHolder="Sélectionner une classe"
            nzAllowClear
            style="width: 250px;"
            (ngModelChange)="onClassroomSelectedForListing($event)">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
          <button nz-button nzType="primary" (click)="openStudentInfoModal()">
            <span nz-icon nzType="plus"></span>
            Ajouter des informations d'élève
          </button>
        </div>

        <nz-table [nzData]="studentInfos" [nzPageSize]="10" nzShowSizeChanger>
          <thead>
            <tr>
              <th>Identifiant unique</th>
              <th>Élève</th>
              <th>Date de naissance</th>
              <th>Lieu de naissance</th>
              <th>Genre</th>
              <th>Redoublant</th>
              <th>Parents</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let info of studentInfos">
              <td>{{ info.uniqueIdentifier }}</td>
              <td>{{ info.studentName || 'N/A' }}</td>
              <td>{{ info.birthDate | date:'dd/MM/yyyy' }}</td>
              <td>{{ info.birthPlace }}</td>
              <td>{{ info.gender === 'M' ? 'Masculin' : 'Féminin' }}</td>
              <td>{{ info.isRepeating ? 'Oui' : 'Non' }}</td>
              <td>{{ info.parentNames }}</td>
            </tr>
          </tbody>
        </nz-table>
      </nz-tab>

      <!-- Onglet 2: Compétences -->
      <nz-tab nzTitle="Compétences">
        <div style="margin-bottom: 16px; display: flex; gap: 16px; align-items: center;">
          <nz-select
            [(ngModel)]="selectedSubjectForCompetence"
            nzPlaceHolder="Sélectionner une matière"
            nzAllowClear
            style="width: 300px;"
            (ngModelChange)="onSubjectSelectedForCompetence($event)">
            <nz-option *ngFor="let subject of subjects" [nzValue]="subject.id" [nzLabel]="subject.name"></nz-option>
          </nz-select>
          <button nz-button nzType="primary" (click)="openCompetenceModal()">
            <span nz-icon nzType="plus"></span>
            Ajouter une compétence
          </button>
        </div>

        <nz-table [nzData]="competences" [nzPageSize]="10" nzShowSizeChanger>
          <thead>
            <tr>
              <th>Ordre</th>
              <th>Description</th>
              <th>Matière</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let competence of competences">
              <td>{{ competence.orderNumber }}</td>
              <td>{{ competence.description }}</td>
              <td>{{ competence.subjectName || 'N/A' }}</td>
            </tr>
          </tbody>
        </nz-table>
      </nz-tab>

      <!-- Onglet 3: Notes -->
      <nz-tab nzTitle="Notes">
        <div style="margin-bottom: 16px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
          <nz-select
            [(ngModel)]="selectedClassroomForGrade"
            nzPlaceHolder="Sélectionner une classe"
            nzAllowClear
            style="width: 200px;"
            (ngModelChange)="onClassroomSelectedForGrade($event)">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
          <nz-select
            [(ngModel)]="selectedStudentForGrade"
            nzPlaceHolder="Sélectionner un élève"
            nzAllowClear
            nzShowSearch
            [nzFilterOption]="filterStudentOption"
            style="width: 200px;"
            [nzDisabled]="!selectedClassroomForGrade || studentsForGrade.length === 0"
            (ngModelChange)="loadGrades()">
            <nz-option *ngFor="let student of studentsForGrade" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
          </nz-select>
          <div *ngIf="selectedClassroomForGrade && studentsForGrade.length === 0 && !loading" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Aucun élève inscrit dans cette classe
          </div>
          <div *ngIf="!selectedClassroomForGrade" style="color: #999; font-size: 12px; margin-top: 4px;">
            Veuillez d'abord sélectionner une classe
          </div>
          <nz-select
            [(ngModel)]="selectedTerm"
            nzPlaceHolder="Sélectionner un trimestre"
            nzAllowClear
            style="width: 200px;"
            (ngModelChange)="onTermSelected()">
            <nz-option *ngFor="let term of terms" [nzValue]="term.id" [nzLabel]="term.name"></nz-option>
          </nz-select>
          <nz-select
            [(ngModel)]="selectedSequence"
            nzPlaceHolder="Sélectionner une séquence (optionnel)"
            nzAllowClear
            style="width: 200px;"
            (ngModelChange)="onSequenceSelected()">
            <nz-option *ngFor="let sequence of sequences" [nzValue]="sequence.id" [nzLabel]="sequence.name"></nz-option>
          </nz-select>
          <button nz-button nzType="primary" (click)="openGradeModal()" [disabled]="!selectedStudentForGrade || !selectedTerm">
            <span nz-icon nzType="plus"></span>
            Ajouter une note
          </button>
        </div>

        <nz-table [nzData]="grades" [nzPageSize]="10" nzShowSizeChanger>
          <thead>
            <tr>
              <th>Compétence</th>
              <th>Note /20</th>
              <th>Coefficient</th>
              <th>M × Coef</th>
              <th>Cote</th>
              <th>Appréciation</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let grade of grades">
              <td>{{ grade.competenceName || grade.competence?.description || 'N/A' }}</td>
              <td>{{ grade.noteM20 }}</td>
              <td>{{ grade.coefficient }}</td>
              <td>{{ grade.mXCoef }}</td>
              <td>{{ grade.cote }}</td>
              <td>{{ grade.appreciation || '-' }}</td>
              <td>
                <button nz-button nzType="link" nzSize="small" (click)="editGrade(grade)">
                  <span nz-icon nzType="edit"></span>
                </button>
                <button nz-button nzType="link" nzDanger nzSize="small" (click)="deleteGrade(grade)">
                  <span nz-icon nzType="delete"></span>
                </button>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </nz-tab>

      <!-- Onglet 4: Records disciplinaires -->
      <nz-tab nzTitle="Records disciplinaires">
        <div style="margin-bottom: 16px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
          <nz-select
            [(ngModel)]="selectedClassroomForDiscipline"
            nzPlaceHolder="Sélectionner une classe"
            nzAllowClear
            style="width: 200px;"
            (ngModelChange)="onClassroomSelectedForDiscipline($event)">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
          <nz-select
            [(ngModel)]="selectedStudentForDiscipline"
            nzPlaceHolder="Sélectionner un élève"
            nzAllowClear
            nzShowSearch
            [nzFilterOption]="filterStudentOption"
            style="width: 200px;"
            [nzDisabled]="!selectedClassroomForDiscipline || studentsForDiscipline.length === 0"
            (ngModelChange)="loadDisciplineRecords()">
            <nz-option *ngFor="let student of studentsForDiscipline" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
          </nz-select>
          <nz-select
            [(ngModel)]="selectedTerm"
            nzPlaceHolder="Sélectionner un trimestre"
            nzAllowClear
            style="width: 200px;"
            (ngModelChange)="loadDisciplineRecords()">
            <nz-option *ngFor="let term of terms" [nzValue]="term.id" [nzLabel]="term.name"></nz-option>
          </nz-select>
          <button nz-button nzType="primary" (click)="openDisciplineModal()" [disabled]="!selectedStudentForDiscipline || !selectedTerm">
            <span nz-icon nzType="plus"></span>
            Ajouter un record disciplinaire
          </button>
        </div>
        <div *ngIf="selectedClassroomForDiscipline && studentsForDiscipline.length === 0 && !loading" style="color: #ff4d4f; font-size: 12px; margin-bottom: 16px;">
          Aucun élève inscrit dans cette classe
        </div>
        <div *ngIf="!selectedClassroomForDiscipline" style="color: #999; font-size: 12px; margin-bottom: 16px;">
          Veuillez d'abord sélectionner une classe
        </div>

        <nz-table [nzData]="disciplineRecords" [nzPageSize]="10" nzShowSizeChanger>
          <thead>
            <tr>
              <th>Élève</th>
              <th>Absences injustifiées (h)</th>
              <th>Absences justifiées (h)</th>
              <th>Retards</th>
              <th>Heures de retenue</th>
              <th>Avertissement</th>
              <th>Blâme</th>
              <th>Jours d'exclusion</th>
              <th>Exclusion définitive</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let record of disciplineRecords">
              <td>{{ record.studentName || record.student?.fullName || 'N/A' }}</td>
              <td>{{ record.unjustifiedAbsencesHours }}</td>
              <td>{{ record.justifiedAbsencesHours }}</td>
              <td>{{ record.lateCount }}</td>
              <td>{{ record.detentionHours }}</td>
              <td>{{ record.conductWarning ? 'Oui' : 'Non' }}</td>
              <td>{{ record.conductBlame ? 'Oui' : 'Non' }}</td>
              <td>{{ record.exclusionDays }}</td>
              <td>{{ record.permanentExclusion ? 'Oui' : 'Non' }}</td>
              <td>
                <button nz-button nzType="link" nzSize="small" (click)="editDiscipline(record)">
                  <span nz-icon nzType="edit"></span>
                </button>
                <button nz-button nzType="link" nzDanger nzSize="small" (click)="deleteDiscipline(record)">
                  <span nz-icon nzType="delete"></span>
                </button>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </nz-tab>

      <!-- Onglet 5: Absences -->
      <nz-tab nzTitle="Absences">
        <div style="margin-bottom: 16px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
          <nz-select
            [(ngModel)]="selectedClassroomForAbsence"
            nzPlaceHolder="Sélectionner une classe"
            nzAllowClear
            style="width: 200px;"
            (ngModelChange)="onClassroomSelectedForAbsence($event)">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
          <nz-select
            [(ngModel)]="selectedSubjectForAbsence"
            nzPlaceHolder="Sélectionner une matière"
            nzAllowClear
            style="width: 200px;"
            (ngModelChange)="loadAbsences()">
            <nz-option *ngFor="let subject of subjects" [nzValue]="subject.id" [nzLabel]="subject.name"></nz-option>
          </nz-select>
          <nz-date-picker
            [(ngModel)]="selectedDateForAbsence"
            nzPlaceHolder="Sélectionner une date"
            nzFormat="yyyy-MM-dd"
            style="width: 200px;"
            (ngModelChange)="loadAbsences()">
          </nz-date-picker>
          <button nz-button nzType="primary" (click)="openAbsenceModal()" [disabled]="!selectedClassroomForAbsence">
            <span nz-icon nzType="plus"></span>
            Enregistrer des absences
          </button>
        </div>

        <!-- Section pour les rapports d'absences par élève -->
        <nz-divider nzText="Rapport d'absences par élève"></nz-divider>
        <div style="margin-bottom: 16px; display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
          <nz-select
            [(ngModel)]="selectedStudentForAbsenceReport"
            nzPlaceHolder="Sélectionner un élève"
            nzAllowClear
            nzShowSearch
            [nzFilterOption]="filterStudentOption"
            style="width: 200px;"
            [nzDisabled]="!selectedClassroomForAbsence || studentsForAbsence.length === 0">
            <nz-option *ngFor="let student of studentsForAbsence" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
          </nz-select>
          <nz-date-picker
            [(ngModel)]="startDateForAbsence"
            nzPlaceHolder="Date de début"
            nzFormat="yyyy-MM-dd"
            style="width: 200px;"
            (ngModelChange)="loadStudentAbsences()">
          </nz-date-picker>
          <nz-date-picker
            [(ngModel)]="endDateForAbsence"
            nzPlaceHolder="Date de fin"
            nzFormat="yyyy-MM-dd"
            style="width: 200px;"
            (ngModelChange)="loadStudentAbsences()">
          </nz-date-picker>
          <button nz-button nzType="default" (click)="loadStudentAbsences()" [disabled]="!selectedStudentForAbsenceReport || !startDateForAbsence || !endDateForAbsence">
            <span nz-icon nzType="search"></span>
            Rechercher
          </button>
        </div>
        <div *ngIf="totalAbsenceHours > 0" style="margin-bottom: 16px; padding: 12px; background-color: #f0f0f0; border-radius: 4px;">
          <strong>Total d'heures d'absence : {{ totalAbsenceHours }} heures</strong>
        </div>

        <nz-table [nzData]="absences" [nzPageSize]="10" nzShowSizeChanger>
          <thead>
            <tr>
              <th>Date</th>
              <th>Classe</th>
              <th>Matière</th>
              <th>Élèves absents</th>
              <th>Nombre d'heures</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let absence of absences">
              <td>{{ absence.date | date:'dd/MM/yyyy' }}</td>
              <td>{{ absence.classRoomLabel || absence.classRoom?.label || absence.classRoomId || 'N/A' }}</td>
              <td>{{ absence.subjectName || absence.subject?.name || absence.subjectId || 'N/A' }}</td>
              <td>
                <nz-tag *ngIf="absence.studentName" style="margin: 2px;">
                  {{ absence.studentName }}
                </nz-tag>
                <span *ngIf="!absence.studentName && absence.absentStudents && absence.absentStudents.length > 0">
                  <nz-tag *ngFor="let student of absence.absentStudents" style="margin: 2px;">
                    {{ student.fullName || student.firstName + ' ' + student.lastName || student.id }}
                  </nz-tag>
                </span>
                <span *ngIf="!absence.studentName && (!absence.absentStudents || absence.absentStudents.length === 0)">
                  {{ absence.absentStudentIds?.length || 0 }} élève(s)
                </span>
              </td>
              <td>{{ absence.numberOfHours }}</td>
              <td>{{ absence.notes || '-' }}</td>
              <td>
                <button nz-button nzType="link" nzSize="small" (click)="editAbsence(absence)">
                  <span nz-icon nzType="edit"></span>
                </button>
                <button nz-button nzType="link" nzDanger nzSize="small" (click)="deleteAbsence(absence)">
                  <span nz-icon nzType="delete"></span>
                </button>
              </td>
            </tr>
          </tbody>
        </nz-table>
      </nz-tab>

      <!-- Onglet 6: Bulletins -->
      <nz-tab nzTitle="Bulletins">
        <div style="margin-bottom: 16px; padding: 16px; background-color: #f9f9f9; border-radius: 4px;">
          <h3 style="margin-top: 0;">Générer un Bulletin Scolaire</h3>
          <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
            <nz-select
              [(ngModel)]="selectedClassroomForReportCard"
              nzPlaceHolder="Sélectionner une classe"
              nzAllowClear
              style="width: 200px;"
              (ngModelChange)="onClassroomSelectedForReportCard($event)">
              <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
            </nz-select>
            <nz-select
              [(ngModel)]="selectedStudentForReportCard"
              nzPlaceHolder="Sélectionner un élève"
              nzAllowClear
              nzShowSearch
              [nzFilterOption]="filterStudentOptionForReportCard"
              style="width: 250px;"
              [nzDisabled]="!selectedClassroomForReportCard || studentsForReportCard.length === 0">
              <nz-option *ngFor="let student of studentsForReportCard" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
            </nz-select>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="margin-right: 8px;">Type de période:</label>
            <nz-select
              [(ngModel)]="reportCardPeriodType"
              style="width: 150px;"
              (ngModelChange)="onReportCardPeriodTypeChange()">
              <nz-option [nzValue]="'TERM'" nzLabel="Trimestre"></nz-option>
              <nz-option [nzValue]="'SEQUENCE'" nzLabel="Séquence"></nz-option>
            </nz-select>
          </div>
          <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
            <nz-select
              *ngIf="reportCardPeriodType === 'TERM'"
              [(ngModel)]="selectedTermForReportCard"
              nzPlaceHolder="Sélectionner un trimestre"
              nzAllowClear
              style="width: 200px;">
              <nz-option *ngFor="let term of terms" [nzValue]="term.id" [nzLabel]="term.name"></nz-option>
            </nz-select>
            <div *ngIf="reportCardPeriodType === 'SEQUENCE'" style="display: flex; gap: 16px; align-items: center;">
              <nz-select
                [(ngModel)]="selectedTermForReportCard"
                nzPlaceHolder="Sélectionner un trimestre"
                nzAllowClear
                style="width: 200px;"
                (ngModelChange)="loadSequencesForReportCard()">
                <nz-option *ngFor="let term of terms" [nzValue]="term.id" [nzLabel]="term.name"></nz-option>
              </nz-select>
              <nz-select
                [(ngModel)]="selectedSequenceForReportCard"
                nzPlaceHolder="Sélectionner une séquence"
                nzAllowClear
                style="width: 200px;"
                [nzDisabled]="!selectedTermForReportCard">
                <nz-option *ngFor="let sequence of sequences" [nzValue]="sequence.id" [nzLabel]="sequence.name"></nz-option>
              </nz-select>
            </div>
            <button
              nz-button
              nzType="primary"
              (click)="loadReportCard()"
              [nzLoading]="isLoadingReportCard"
              [disabled]="!selectedStudentForReportCard || !selectedClassroomForReportCard || (reportCardPeriodType === 'TERM' ? !selectedTermForReportCard : !selectedSequenceForReportCard)">
              <span nz-icon nzType="file-text"></span>
              Générer le bulletin
            </button>
          </div>
        </div>
      </nz-tab>
    </nz-tabset>
  </nz-spin>
</nz-card>

<!-- Modal: Informations des élèves -->
<nz-modal
  [(nzVisible)]="isStudentInfoModalVisible"
  nzTitle="Ajouter des informations d'élève"
  (nzOnCancel)="handleStudentInfoCancel()"
  (nzOnOk)="submitStudentInfo()"
  [nzOkLoading]="isSubmittingStudentInfo"
  [nzOkDisabled]="studentInfoForm.invalid">
  <ng-container *nzModalContent>
    <form [formGroup]="studentInfoForm" nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Classe</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une classe">
          <nz-select formControlName="classRoomId" nzPlaceHolder="Sélectionner une classe">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Élève</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner un élève inscrit dans la classe">
          <nz-select
            formControlName="studentId"
            nzPlaceHolder="Rechercher et sélectionner un élève"
            [nzDisabled]="!studentInfoForm.get('classRoomId')?.value || enrolledStudents.length === 0"
            nzShowSearch
            nzAllowClear
            [nzFilterOption]="filterStudentOption">
            <nz-option *ngFor="let student of enrolledStudents" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
          </nz-select>
          <div *ngIf="!studentInfoForm.get('classRoomId')?.value" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Veuillez d'abord sélectionner une classe
          </div>
          <div *ngIf="studentInfoForm.get('classRoomId')?.value && enrolledStudents.length === 0" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Aucun élève inscrit dans cette classe
          </div>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Parent</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner un parent">
          <nz-select
            formControlName="parentId"
            nzPlaceHolder="Rechercher et sélectionner un parent"
            nzShowSearch
            nzAllowClear
            [nzFilterOption]="filterParentOption">
            <nz-option *ngFor="let parent of parents" [nzValue]="parent.id" [nzLabel]="parent.label"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Date de naissance</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une date">
          <nz-date-picker formControlName="birthDate" nzFormat="yyyy-MM-dd" style="width: 100%;"></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Lieu de naissance</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir le lieu de naissance">
          <input nz-input formControlName="birthPlace" placeholder="Ex: Douala, Cameroun" type="text" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Genre</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select formControlName="gender">
            <nz-option nzValue="M" nzLabel="Masculin"></nz-option>
            <nz-option nzValue="F" nzLabel="Féminin"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Redoublant</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-switch formControlName="isRepeating"></nz-switch>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">URL Photo</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <input nz-input formControlName="photoUrl" placeholder="https://example.com/photos/student-001.jpg" type="url" />
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Modal: Compétences -->
<nz-modal
  [(nzVisible)]="isCompetenceModalVisible"
  nzTitle="Ajouter une compétence"
  (nzOnCancel)="handleCompetenceCancel()"
  (nzOnOk)="submitCompetence()"
  [nzOkLoading]="isSubmittingCompetence"
  [nzOkDisabled]="competenceForm.invalid">
  <ng-container *nzModalContent>
    <form [formGroup]="competenceForm" nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Matière</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une matière">
          <nz-select formControlName="subjectId" nzPlaceHolder="Sélectionner une matière">
            <nz-option *ngFor="let subject of subjects" [nzValue]="subject.id" [nzLabel]="subject.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Description</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir la description">
          <textarea nz-input formControlName="description" rows="4" placeholder="Description de la compétence"></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Modal: Notes -->
<nz-modal
  [(nzVisible)]="isGradeModalVisible"
  [nzTitle]="editingGrade ? 'Modifier une note' : 'Ajouter une note'"
  (nzOnCancel)="handleGradeCancel()"
  (nzOnOk)="submitGrade()"
  [nzOkLoading]="isSubmittingGrade"
  [nzOkDisabled]="gradeForm.invalid"
  [nzWidth]="800">
  <ng-container *nzModalContent>
    <form [formGroup]="gradeForm" nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Classe</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une classe">
          <nz-select formControlName="classRoomId" nzPlaceHolder="Sélectionner une classe">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Compétence</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une compétence">
          <nz-select formControlName="competenceId" nzPlaceHolder="Sélectionner une compétence">
            <nz-option *ngFor="let competence of competences" [nzValue]="competence.id" [nzLabel]="competence.description"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Élève</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner un élève inscrit dans la classe">
          <nz-select
            formControlName="studentId"
            nzPlaceHolder="Rechercher et sélectionner un élève"
            nzShowSearch
            nzAllowClear
            [nzFilterOption]="filterStudentOption"
            [nzDisabled]="!gradeForm.get('classRoomId')?.value || studentsForGradeModal.length === 0">
            <nz-option *ngFor="let student of studentsForGradeModal" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
          </nz-select>
          <div *ngIf="!gradeForm.get('classRoomId')?.value" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Veuillez d'abord sélectionner une classe
          </div>
          <div *ngIf="gradeForm.get('classRoomId')?.value && studentsForGradeModal.length === 0" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Aucun élève inscrit dans cette classe
          </div>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Trimestre</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner un trimestre">
          <nz-select formControlName="termId" nzPlaceHolder="Sélectionner un trimestre">
            <nz-option *ngFor="let term of terms" [nzValue]="term.id" [nzLabel]="term.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Séquence</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select formControlName="sequenceId" nzPlaceHolder="Sélectionner une séquence (optionnel)" nzAllowClear>
            <nz-option *ngFor="let sequence of sequences" [nzValue]="sequence.id" [nzLabel]="sequence.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Note /20</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir une note entre 0 et 20">
          <nz-input-number formControlName="noteN20" [nzMin]="0" [nzMax]="20" [nzStep]="0.5" (ngModelChange)="calculateGradeValues()" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Note moyenne /20</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir une note entre 0 et 20">
          <nz-input-number formControlName="noteM20" [nzMin]="0" [nzMax]="20" [nzStep]="0.5" (ngModelChange)="calculateGradeValues()" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Coefficient</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir un coefficient">
          <nz-input-number formControlName="coefficient" [nzMin]="0.1" [nzStep]="0.5" (ngModelChange)="calculateGradeValues()" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>M × Coef</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-input-number formControlName="mXCoef" [nzDisabled]="true" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Cote</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-input-number formControlName="cote" [nzDisabled]="true" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Note minimale</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-input-number formControlName="minScore" [nzMin]="0" [nzMax]="20" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Note maximale</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-input-number formControlName="maxScore" [nzMin]="0" [nzMax]="20" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Appréciation</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <textarea nz-input formControlName="appreciation" rows="3" placeholder="Appréciation du professeur"></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Modal: Records disciplinaires -->
<nz-modal
  [(nzVisible)]="isDisciplineModalVisible"
  [nzTitle]="editingDiscipline ? 'Modifier un record disciplinaire' : 'Ajouter un record disciplinaire'"
  (nzOnCancel)="handleDisciplineCancel()"
  (nzOnOk)="submitDiscipline()"
  [nzOkLoading]="isSubmittingDiscipline"
  [nzOkDisabled]="disciplineForm.invalid"
  [nzWidth]="800">
  <ng-container *nzModalContent>
    <form [formGroup]="disciplineForm" nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Classe</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une classe">
          <nz-select formControlName="classRoomId" nzPlaceHolder="Sélectionner une classe">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Élève</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner un élève inscrit dans la classe">
          <nz-select
            formControlName="studentId"
            nzPlaceHolder="Rechercher et sélectionner un élève"
            nzShowSearch
            nzAllowClear
            [nzFilterOption]="filterStudentOption"
            [nzDisabled]="!disciplineForm.get('classRoomId')?.value || studentsForDisciplineModal.length === 0">
            <nz-option *ngFor="let student of studentsForDisciplineModal" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
          </nz-select>
          <div *ngIf="!disciplineForm.get('classRoomId')?.value" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Veuillez d'abord sélectionner une classe
          </div>
          <div *ngIf="disciplineForm.get('classRoomId')?.value && studentsForDisciplineModal.length === 0" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Aucun élève inscrit dans cette classe
          </div>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Trimestre</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner un trimestre">
          <nz-select formControlName="termId" nzPlaceHolder="Sélectionner un trimestre">
            <nz-option *ngFor="let term of terms" [nzValue]="term.id" [nzLabel]="term.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Absences injustifiées (heures)</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir le nombre d'heures">
          <nz-input-number formControlName="unjustifiedAbsencesHours" [nzMin]="0" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Absences justifiées (heures)</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir le nombre d'heures">
          <nz-input-number formControlName="justifiedAbsencesHours" [nzMin]="0" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Nombre de retards</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir le nombre de retards">
          <nz-input-number formControlName="lateCount" [nzMin]="0" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Heures de retenue</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir le nombre d'heures">
          <nz-input-number formControlName="detentionHours" [nzMin]="0" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Avertissement de conduite</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-switch formControlName="conductWarning"></nz-switch>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Blâme de conduite</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-switch formControlName="conductBlame"></nz-switch>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Jours d'exclusion</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir le nombre de jours">
          <nz-input-number formControlName="exclusionDays" [nzMin]="0" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Exclusion définitive</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-switch formControlName="permanentExclusion"></nz-switch>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Modal: Absences -->
<nz-modal
  [(nzVisible)]="isAbsenceModalVisible"
  [nzTitle]="editingAbsence ? 'Modifier les absences' : 'Enregistrer des absences'"
  (nzOnCancel)="handleAbsenceCancel()"
  (nzOnOk)="submitAbsence()"
  [nzOkLoading]="isSubmittingAbsence"
  [nzOkDisabled]="absenceForm.invalid"
  [nzWidth]="900">
  <ng-container *nzModalContent>
    <form [formGroup]="absenceForm" nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Classe</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une classe">
          <nz-select formControlName="classRoomId" nzPlaceHolder="Sélectionner une classe">
            <nz-option *ngFor="let classroom of classrooms" [nzValue]="classroom.id" [nzLabel]="classroom.label"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Matière</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une matière">
          <nz-select formControlName="subjectId" nzPlaceHolder="Sélectionner une matière">
            <nz-option *ngFor="let subject of subjects" [nzValue]="subject.id" [nzLabel]="subject.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Date</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner une date">
          <nz-date-picker formControlName="date" nzFormat="yyyy-MM-dd" style="width: 100%;"></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Horaire (optionnel)</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select formControlName="scheduleId" nzPlaceHolder="Sélectionner un horaire (optionnel)" nzAllowClear>
            <nz-option *ngFor="let schedule of schedules" [nzValue]="schedule.id" [nzLabel]="getScheduleLabel(schedule)"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Nombre d'heures</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez saisir le nombre d'heures">
          <nz-input-number formControlName="numberOfHours" [nzMin]="0.5" [nzStep]="0.5" style="width: 100%;"></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Élèves absents</nz-form-label>
        <nz-form-control [nzSpan]="18" nzErrorTip="Veuillez sélectionner au moins un élève">
          <nz-select
            formControlName="absentStudentIds"
            nzPlaceHolder="Sélectionner les élèves absents"
            nzMode="multiple"
            nzShowSearch
            [nzFilterOption]="filterStudentOption"
            [nzDisabled]="!absenceForm.get('classRoomId')?.value || studentsForAbsenceModal.length === 0"
            style="width: 100%;">
            <nz-option *ngFor="let student of studentsForAbsenceModal" [nzValue]="student.id" [nzLabel]="student.label"></nz-option>
          </nz-select>
          <div *ngIf="!absenceForm.get('classRoomId')?.value" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Veuillez d'abord sélectionner une classe
          </div>
          <div *ngIf="absenceForm.get('classRoomId')?.value && studentsForAbsenceModal.length === 0" style="color: #ff4d4f; font-size: 12px; margin-top: 4px;">
            Aucun élève inscrit dans cette classe
          </div>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Notes</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <textarea nz-input formControlName="notes" rows="3" placeholder="Notes sur les absences (ex: Cours de mathématiques - Absences non justifiées)"></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- Modal: Bulletin -->
<nz-modal
  [(nzVisible)]="isReportCardModalVisible"
  nzTitle="Bulletin Scolaire"
  (nzOnCancel)="closeReportCardModal()"
  [nzFooter]="null"
  [nzWidth]="1200">
  <ng-container *nzModalContent>
    <nz-spin [nzSpinning]="isLoadingReportCard">
      <div *ngIf="reportCard" style="padding: 20px; background: white;">
        <!-- En-tête -->
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px;">
          <h1 style="margin: 0 0 10px 0;">{{ reportCard.schoolName || 'École' }}</h1>
          <p *ngIf="reportCard.schoolAddress" style="margin: 5px 0;">{{ reportCard.schoolAddress }}</p>
          <p *ngIf="reportCard.schoolPhoneNumber || reportCard.schoolEmail" style="margin: 5px 0;">
            <span *ngIf="reportCard.schoolPhoneNumber">Tél: {{ reportCard.schoolPhoneNumber }}</span>
            <span *ngIf="reportCard.schoolPhoneNumber && reportCard.schoolEmail"> | </span>
            <span *ngIf="reportCard.schoolEmail">Email: {{ reportCard.schoolEmail }}</span>
          </p>
          <h2 style="margin: 15px 0 10px 0;">BULLETIN SCOLAIRE</h2>
          <p style="margin: 5px 0;"><strong>{{ (reportCard.termName || '') || (reportCard.sequenceName || '') }}</strong></p>
          <p style="margin: 5px 0;">Année scolaire : {{ reportCard.academicYearLabel || reportCard.academicYearId }}</p>
        </div>

        <!-- Informations de l'élève -->
        <div style="display: flex; justify-content: space-between; margin: 20px 0; padding: 15px; background-color: #f9f9f9; border: 1px solid #ddd;">
          <div>
            <p><strong>Nom et Prénoms de l'élève :</strong> {{ reportCard.studentName }}</p>
            <p *ngIf="reportCard.studentUniqueIdentifier"><strong>Identifiant Unique :</strong> {{ reportCard.studentUniqueIdentifier }}</p>
            <p *ngIf="reportCard.studentBirthDate"><strong>Date et lieu de naissance :</strong> {{ reportCard.studentBirthDate | date:'dd/MM/yyyy' }}{{ reportCard.studentBirthPlace ? ' - ' + reportCard.studentBirthPlace : '' }}</p>
            <p *ngIf="reportCard.studentGender"><strong>Genre :</strong> {{ reportCard.studentGender === 'M' ? 'Masculin' : 'Féminin' }}</p>
            <p *ngIf="reportCard.parentNames"><strong>Noms et contacts des Parents / Tuteurs :</strong> {{ reportCard.parentNames }}{{ reportCard.parentContacts ? ' - ' + reportCard.parentContacts : '' }}</p>
          </div>
          <div>
            <p><strong>Classe :</strong> {{ reportCard.classRoomLabel || reportCard.classRoomId }}</p>
            <p *ngIf="reportCard.studentIsRepeating !== undefined"><strong>Redoublant :</strong> {{ reportCard.studentIsRepeating ? 'Oui' : 'Non' }}</p>
          </div>
        </div>

        <!-- Notes par matière -->
        <div style="margin: 20px 0;">
          <h3>NOTES</h3>
          <div *ngFor="let subjectGrade of reportCard.subjectGrades" style="margin-bottom: 20px;">
            <h4 style="background-color: #f0f0f0; padding: 8px; margin: 10px 0;">{{ subjectGrade.subjectName }} ({{ subjectGrade.teacherName || 'M/Mme' }})</h4>
            <nz-table [nzData]="subjectGrade.competences" [nzShowPagination]="false" style="margin-bottom: 15px;">
              <thead>
                <tr>
                  <th>COMPÉTENCES ÉVALUÉES</th>
                  <th style="text-align: center;">N/20</th>
                  <th style="text-align: center;">M/20</th>
                  <th style="text-align: center;">Coef</th>
                  <th style="text-align: center;">M×Coef</th>
                  <th style="text-align: center;">COTE</th>
                  <th style="text-align: center;">[Min - Max]</th>
                  <th>Appréciations</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let competence of subjectGrade.competences">
                  <td>{{ competence.competenceDescription }}</td>
                  <td style="text-align: center;">{{ competence.noteN20 }}</td>
                  <td style="text-align: center;">{{ competence.noteM20 }}</td>
                  <td style="text-align: center;">{{ competence.coefficient }}</td>
                  <td style="text-align: center;">{{ competence.mXCoef }}</td>
                  <td style="text-align: center;">{{ competence.cote }}</td>
                  <td style="text-align: center;">{{ competence.minScore !== undefined && competence.maxScore !== undefined ? '[' + competence.minScore + ' - ' + competence.maxScore + ']' : '-' }}</td>
                  <td>{{ competence.appreciation || '-' }}</td>
                </tr>
              </tbody>
            </nz-table>
            <div style="margin-top: 10px; padding: 8px; background-color: #f9f9f9;">
              <strong>Matière - TOTAL: {{ subjectGrade.totalScore }} | MOYENNE: {{ subjectGrade.averageScore }} | COEF: {{ subjectGrade.subjectCoefficient }} | MOYENNE × COEF: {{ subjectGrade.weightedAverage }} | COTE: {{ subjectGrade.cote }}</strong>
            </div>
          </div>
        </div>

        <!-- Statistiques -->
        <div style="margin: 20px 0; padding: 15px; background-color: #f0f0f0; border: 1px solid #ddd;">
          <h3>Travail de l'élève</h3>
          <nz-table [nzData]="[{}]" [nzShowPagination]="false">
            <tbody>
              <tr>
                <td><strong>TOTAL GENERAL:</strong></td>
                <td><strong>{{ reportCard.totalGeneral || 0 }}</strong></td>
              </tr>
              <tr>
                <td><strong>COEF:</strong></td>
                <td><strong>{{ reportCard.totalCoefficient || 0 }}</strong></td>
              </tr>
              <tr>
                <td><strong>MOYENNE TRIM:</strong></td>
                <td><strong>{{ (reportCard.averageTrim || 0).toFixed(2) }} / 20</strong></td>
              </tr>
              <tr>
                <td><strong>COTE:</strong></td>
                <td><strong>{{ (reportCard.cote || 0).toFixed(2) }} / 20</strong></td>
              </tr>
              <tr *ngIf="reportCard.totalAbsenceHours !== undefined">
                <td>Total heures d'absence:</td>
                <td>{{ reportCard.totalAbsenceHours }}</td>
              </tr>
            </tbody>
          </nz-table>
        </div>

        <!-- Record disciplinaire -->
        <div *ngIf="reportCard.disciplineRecord" style="margin: 20px 0; padding: 15px; background-color: #fff9e6; border: 1px solid #ddd;">
          <h3>Record Disciplinaire</h3>
          <nz-table [nzData]="[{}]" [nzShowPagination]="false">
            <tbody>
              <tr>
                <td>Absences non justifiées (heures):</td>
                <td>{{ reportCard.disciplineRecord.unjustifiedAbsencesHours }}</td>
              </tr>
              <tr>
                <td>Absences justifiées (heures):</td>
                <td>{{ reportCard.disciplineRecord.justifiedAbsencesHours }}</td>
              </tr>
              <tr>
                <td>Nombre de retards:</td>
                <td>{{ reportCard.disciplineRecord.lateCount }}</td>
              </tr>
              <tr>
                <td>Heures de retenue:</td>
                <td>{{ reportCard.disciplineRecord.detentionHours }}</td>
              </tr>
              <tr *ngIf="reportCard.disciplineRecord.conductWarning">
                <td colspan="2"><strong>Avertissement de conduite</strong></td>
              </tr>
              <tr *ngIf="reportCard.disciplineRecord.conductBlame">
                <td colspan="2"><strong>Blâme</strong></td>
              </tr>
              <tr *ngIf="reportCard.disciplineRecord.exclusionDays > 0">
                <td colspan="2"><strong>Exclusion: {{ reportCard.disciplineRecord.exclusionDays }} jour(s)</strong></td>
              </tr>
              <tr *ngIf="reportCard.disciplineRecord.permanentExclusion">
                <td colspan="2"><strong>Exclusion définitive</strong></td>
              </tr>
            </tbody>
          </nz-table>
        </div>

        <!-- Date de génération -->
        <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
          <p>Généré le {{ reportCard.generatedDate | date:'dd/MM/yyyy' }}</p>
        </div>

        <!-- Bouton de téléchargement -->
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
          <button nz-button nzType="primary" (click)="downloadReportCardPDF()">
            <span nz-icon nzType="download"></span>
            Télécharger/Imprimer le PDF
          </button>
        </div>
      </div>
    </nz-spin>
  </ng-container>
</nz-modal>
